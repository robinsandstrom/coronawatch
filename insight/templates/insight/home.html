<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0 minimal-ui"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.0/css/mdb.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.0/js/mdb.min.js"></script>
    <script src="https://www.amcharts.com/lib/4/core.js"></script>
    <script src="https://www.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="https://www.amcharts.com/lib/4/maps.js"></script>
    <script src="https://www.amcharts.com/lib/4/geodata/usaLow.js"></script>

    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">

</head>

<body class="grey darken-4">
        <!-- As a link -->
    <nav class="navbar navbar-dark special-color z-depth-0 text-left">
        <img style="height: 2.5rem;" src="{% static 'logob.svg' %}" class="pr-4">
        <a class="navbar-brand mr-auto py-0 my-0" href="#" style="font-family: biohazard;">Coronawatch.se</a>
        <h6 class="text-white text-uppercase">Senast uppdaterad: </h6><h4 class="ml-1 text-uppercase text-white"><strong>Idag 20:06</strong></h4>
    </nav>
    <div class="row">
        <div class="col-sm-12 col-lg-3 pr-0">
            <div class="card h-100 border-dark ml-lg-2 mr-lg-0 my-2 z-depth-0">
                <div class="card-header text-white special-color-dark text-center">
                    Totalt antal fall
                </div>
                <div class="card-body text-center text-danger special-color">
                    <h1>136</h1>
                    <hr>
                    <h2 class="text-white">+45</h2>
                    <h6 class="text-muted">(senaste 24h)</h6>
                </div>

                <div class="card-header text-white special-color-dark text-center">
                    Fall per region
                </div>
                <div class="card-body text-danger special-color">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-white text-uppercase">Stockholm:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>80</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Västra Götaland:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>14</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Skåne:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>14</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Värmland:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>13</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Jönköpings län:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>8</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Uppsala:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>5</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Örebro län:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>1</strong></td>
                        </tr>
                        <tr>
                            <td class="text-white text-uppercase">Gävleborg:</td>
                            <td style="text-align: right !important;" class="text-danger"><strong>1</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-lg-6 px-2" >
            <div class="card border-dark mx-lg-0 my-2 z-depth-0 h-100">
                <div class="card-header text-white special-color-dark text-center">
                    Utveckling
                </div>
                <div class="card-body text-center text-danger special-color">
                    <div id="chartdiv"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-lg-3 pl-0" >
            <div class="card border-dark mr-lg-1 my-2 z-depth-0 h-100">
                <div class="card-header text-white special-color-dark text-center">
                    Utveckling
                </div>
                <div class="card-body special-color">
                    <table class="table table-borderless table-sm">
                        <thead>
                            <tr>
                                <th class="text-white">Datum</th>
                                <th class="text-white">Prognos</th>
                                <th class="text-white">Utfall</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-white">6e Mars</td>
                                <td class="text-danger">72</td>
                                <td class="text-warning">94</td>
                            </tr>
                            <tr>
                                <td class="text-white">7e Mars</td>
                                <td class="text-danger">137</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">8e Mars</td>
                                <td class="text-danger">200</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">9e Mars</td>
                                <td class="text-danger">291</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">10e Mars</td>
                                <td class="text-danger">425</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">11e Mars</td>
                                <td class="text-danger">620</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">12e Mars</td>
                                <td class="text-danger">904</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">13e Mars</td>
                                <td class="text-danger">1320</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">14e Mars</td>
                                <td class="text-danger">1924</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">15e Mars</td>
                                <td class="text-danger">2807</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">16e Mars</td>
                                <td class="text-danger">4094</td>
                                <td class="text-muted">-</td>
                            </tr>
                            <tr>
                                <td class="text-white">17e Mars</td>
                                <td class="text-danger">5000+</td>
                                <td class="text-muted">-</td>
                            </tr>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card border-dark mx-lg-0 my-4 z-depth-0 h-100">
                <div class="card-header text-white special-color-dark text-center">
                    Utveckling
                </div>
                <div class="card-body text-center text-danger special-color">
                    <div id="map_chart_div"></div>
                </div>
            </div>
        </div>
    </div>


</body>
<script>
am4core.ready(function() {

    // Themes begin
    am4core.useTheme(am4themes_dark);
    // Themes end


function createLineChart(){

    // Create chart instance
    var chart = am4core.create("chartdiv", am4charts.XYChart);

    // Create axes
    var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
    var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

    var data = {{ data|safe }}

    var land = {
            1: 'Kina',
            2: 'Iran',
            3: 'Italien',
            4: 'Sydkorea',
            5: 'Frankrike',
            6: 'Tyskland',
            7: 'Spanien',
            8: 'Sverige',
    }

    for (var i = 1; i < 9; i++) {
      createSeries("value" + i, land[i], data[i]);
    }

    // Create series
    function createSeries(s, name, data_row) {
        var series = chart.series.push(new am4charts.LineSeries());
        series.dataFields.valueY = "value" + s;
        series.dataFields.dateX = "date";
        series.name = name;

        var segment = series.segments.template;
        segment.interactionsEnabled = true;

        var hoverState = segment.states.create("hover");
        hoverState.properties.strokeWidth = 3;

        var dimmed = segment.states.create("dimmed");
        dimmed.properties.stroke = am4core.color("#dadada");

        segment.events.on("over", function(event) {
          processOver(event.target.parent.parent.parent);
        });

        segment.events.on("out", function(event) {
          processOut(event.target.parent.parent.parent);
        });

        for (var i = 0; i < data_row.length; i++) {
          value = data_row[i];
          var dataItem = {date: new Date(2020, 2, i) };
          dataItem["value" + s] = value;
              if(value != 0){
                  data.push(dataItem);
            }
        }

        series.data = data;
        return series;
    }

    chart.legend = new am4charts.Legend();
    chart.legend.position = "right";
    chart.legend.scrollable = true;
    chart.legend.itemContainers.template.events.on("over", function(event) {
      processOver(event.target.dataItem.dataContext);
    })

    chart.legend.itemContainers.template.events.on("out", function(event) {
      processOut(event.target.dataItem.dataContext);
    })

    function processOver(hoveredSeries) {
      hoveredSeries.toFront();

      hoveredSeries.segments.each(function(segment) {
        segment.setState("hover");
      })

      chart.series.each(function(series) {
        if (series != hoveredSeries) {
          series.segments.each(function(segment) {
            segment.setState("dimmed");
          })
          series.bulletsContainer.setState("dimmed");
        }
      });
    }

    function processOut(hoveredSeries) {
      chart.series.each(function(series) {
        series.segments.each(function(segment) {
          segment.setState("default");
        })
        series.bulletsContainer.setState("default");
      });
    }
}

createLineChart();
createMapChart();

function createMapChart(){
    var chart = am4core.create("map_chart_div", am4maps.MapChart);
    chart.maxZoomLevel = 64;

    // Set map definition
    chart.geodata = am4geodata_usaLow;

    // Set projection
    chart.projection = new am4maps.projections.AlbersUsa();

    // Add button
    var zoomOut = chart.tooltipContainer.createChild(am4core.ZoomOutButton);
    zoomOut.align = "right";
    zoomOut.valign = "top";
    zoomOut.margin(20, 20, 20, 20);
    zoomOut.events.on("hit", function() {
      if (currentSeries) {
        currentSeries.hide();
      }
      chart.goHome();
      zoomOut.hide();
      currentSeries = regionalSeries.US.series;
      currentSeries.show();
    });
    zoomOut.hide();


    // Create map polygon series
    var polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;
    polygonSeries.calculateVisualCenter = true;

    // Configure series
    var polygonTemplate = polygonSeries.mapPolygons.template;
    polygonTemplate.tooltipText = "{name}";
    polygonTemplate.fill = chart.colors.getIndex(0);

    // Load data when map polygons are ready
    chart.events.on("ready", loadStores);

    // Loads store data
    function loadStores() {
      var loader = new am4core.DataSource();
      loader.url = "https://s3-us-west-2.amazonaws.com/s.cdpn.io/t-160/TargetStores.json";
      loader.events.on("parseended", function(ev) {
        setupStores(ev.target.data);
      });
      loader.load();
    }

    // Creates a series
    function createSeries(heatfield) {
      var series = chart.series.push(new am4maps.MapImageSeries());
      series.dataFields.value = heatfield;

      var template = series.mapImages.template;
      template.verticalCenter = "middle";
      template.horizontalCenter = "middle";
      template.propertyFields.latitude = "lat";
      template.propertyFields.longitude = "long";
      template.tooltipText = "{name}:\n[bold]{stores} stores[/]";

      var circle = template.createChild(am4core.Circle);
      circle.radius = 10;
      circle.fillOpacity = 0.7;
      circle.verticalCenter = "middle";
      circle.horizontalCenter = "middle";
      circle.nonScaling = true;

      var label = template.createChild(am4core.Label);
      label.text = "{stores}";
      label.fill = am4core.color("#fff");
      label.verticalCenter = "middle";
      label.horizontalCenter = "middle";
      label.nonScaling = true;

      var heat = series.heatRules.push({
        target: circle,
        property: "radius",
        min: 10,
        max: 30
      });

      // Set up drill-down
      series.mapImages.template.events.on("hit", function(ev) {

        // Determine what we've clicked on
        var data = ev.target.dataItem.dataContext;

        // No id? Individual store - nothing to drill down to further
        if (!data.target) {
          return;
        }

        // Create actual series if it hasn't been yet created
        if (!regionalSeries[data.target].series) {
          regionalSeries[data.target].series = createSeries("count");
          regionalSeries[data.target].series.data = data.markerData;
        }

        // Hide current series
        if (currentSeries) {
          currentSeries.hide();
        }

        // Control zoom
        if (data.type == "state") {
          var statePolygon = polygonSeries.getPolygonById("US-" + data.state);
          chart.zoomToMapObject(statePolygon);
        }
        else if (data.type == "city") {
          chart.zoomToGeoPoint({
            latitude: data.lat,
            longitude: data.long
          }, 64, true);
        }
        zoomOut.show();

        // Show new targert series
        currentSeries = regionalSeries[data.target].series;
        currentSeries.show();
      });

      return series;
    }

    var regionalSeries = {};
    var currentSeries;

    function setupStores(data) {

      // Init country-level series
      regionalSeries.US = {
        markerData: [],
        series: createSeries("stores")
      };

      // Set current series
      currentSeries = regionalSeries.US.series;

      // Process data
      am4core.array.each(data.query_results, function(store) {

        // Get store data
        var store = {
          state: store.MAIL_ST_PROV_C,
          long: am4core.type.toNumber(store.LNGTD_I),
          lat: am4core.type.toNumber(store.LATTD_I),
          location: store.co_loc_n,
          city: store.mail_city_n,
          count: am4core.type.toNumber(store.count)
        };

        // Process state-level data
        if (regionalSeries[store.state] == undefined) {
          var statePolygon = polygonSeries.getPolygonById("US-" + store.state);
          if (statePolygon) {

            // Add state data
            regionalSeries[store.state] = {
              target: store.state,
              type: "state",
              name: statePolygon.dataItem.dataContext.name,
              count: store.count,
              stores: 1,
              lat: statePolygon.visualLatitude,
              long: statePolygon.visualLongitude,
              state: store.state,
              markerData: []
            };
            regionalSeries.US.markerData.push(regionalSeries[store.state]);

          }
          else {
            // State not found
            return;
          }
        }
        else {
          regionalSeries[store.state].stores++;
          regionalSeries[store.state].count += store.count;
        }

        // Process city-level data
        if (regionalSeries[store.city] == undefined) {
          regionalSeries[store.city] = {
            target: store.city,
            type: "city",
            name: store.city,
            count: store.count,
            stores: 1,
            lat: store.lat,
            long: store.long,
            state: store.state,
            markerData: []
          };
          regionalSeries[store.state].markerData.push(regionalSeries[store.city]);
        }
        else {
          regionalSeries[store.city].stores++;
          regionalSeries[store.city].count += store.count;
        }

        // Process individual store
        regionalSeries[store.city].markerData.push({
          name: store.location,
          count: store.count,
          stores: 1,
          lat: store.lat,
          long: store.long,
          state: store.state
        });

      });

      regionalSeries.US.series.data = regionalSeries.US.markerData;
    }

}

}); // end am4core.ready()
</script>


</html>
